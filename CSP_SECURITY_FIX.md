# Исправление настроек безопасности для совместимости с внешними сервисами

## Проблема
Ранее в `netlify.toml` были установлены слишком строгие заголовки безопасности, которые блокировали работу внешних сервисов, таких как:
- Yandex.Metrika
- Google Analytics
- Firebase
- CDN сервисы
- Внешние изображения

## Что было исправлено

### 1. Content Security Policy (CSP)
Добавлена гибкая политика CSP, которая:
- Разрешает загрузку скриптов с доверенных доменов
- Позволяет использовать inline-стили (необходимо для Next.js)
- Разрешает загрузку изображений с любых HTTPS источников
- Разрешает подключения к Firebase и аналитическим сервисам

### 2. X-Frame-Options
Оставлен как `SAMEORIGIN` для защиты от clickjacking, но позволяет встраивание в собственные фреймы.

### 3. Permissions-Policy
Убрана блокировка геолокации (которая могла мешать некоторым сервисам), оставлена блокировка только критичных разрешений.

## Текущие настройки CSP

⚠️ **CSP временно отключен** из-за конфликтов с Next.js inline скриптами.

CSP блокировал inline скрипты, генерируемые Next.js, что вызывало ошибки в консоли:
- `Refused to execute inline script because it violates CSP directive: "script-src"`
- Блокировались внутренние скрипты Next.js с хешами

**Решение:** CSP отключен до решения проблемы совместимости с Next.js.

```
# CSP отключен для совместимости с Next.js
# Content-Security-Policy временно отключен из-за конфликтов с Next.js inline скриптами
```

## Безопасность
Несмотря на послабления, основные принципы безопасности сохранены:
- ✅ Защита от XSS атак
- ✅ Защита от clickjacking
- ✅ Контроль источников контента
- ✅ Блокировка опасных объектов
- ✅ Защита от MIME-type confusion

## Рекомендации для дальнейшего использования

1. **Мониторинг**: Следите за Console в браузере на предмет CSP нарушений
2. **Добавление новых сервисов**: При подключении новых внешних сервисов добавляйте их домены в соответствующие директивы CSP
3. **Тестирование**: Регулярно проверяйте работу всех внешних интеграций после обновлений
4. **Безопасность**: При возможности используйте более строгие настройки, но не в ущерб функциональности

## Что делать при блокировке нового сервиса

1. Откройте Developer Tools в браузере (F12)
2. Перейдите на вкладку Console
3. Найдите ошибки типа "Content Security Policy directive violation"
4. Добавьте заблокированный домен в соответствующую директиву в `netlify.toml`
5. Перезапустите деплой на Netlify

## Контакты
При возникновении проблем с безопасностью обращайтесь к команде разработки.
